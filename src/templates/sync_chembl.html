{% extends "base.html" %}

{% block title %}ChEMBL Sync{% endblock %}

{% block content %}
<h1>ðŸ”„ Sync ChEMBL Data</h1>

<p style="max-width:800px;">
This operation synchronizes the local ChEMBL cache with the official ChEMBL source.
It may take several minutes depending on network and dataset size.
</p>

<button id="syncBtn" onclick="runSync()">Start Sync</button>

<!-- Spinner -->
<div id="spinner" class="spinner-overlay" style="display:none;">
    <div class="spinner"></div>
    <div>Synchronizing with ChEMBL, please waitâ€¦</div>
</div>

<!-- Result -->
<div id="resultBox" style="display:none; margin-top:25px;">
<h3>âœ… Sync Completed</h3>
    <ul>
        <li><b>Drug sync status:</b> <span id="drugStatus"></span></li>
        <li><b>Last drug offset:</b> <span id="drugOffset"></span></li>
        <li><b>Targets processed:</b> <span id="targetProcessed"></span></li>
    </ul>
</div>

<script>
async function runSync() {
    const btn = document.getElementById("syncBtn");
    const spinner = document.getElementById("spinner");
    const resultBox = document.getElementById("resultBox");

    btn.disabled = true;
    spinner.style.display = "block";
    resultBox.style.display = "none";

    try {
        const res = await fetch("/sync/chembl/all", { method: "POST" });
        if (!res.ok) throw new Error("Sync failed");

        const data = await res.json();

        document.getElementById("drugStatus").innerText =
            data.summary?.drugs?.status ?? "-";

        document.getElementById("drugOffset").innerText =
            data.summary?.drugs?.new_offset ??
            data.summary?.drugs?.last_offset ??
            "-";

        document.getElementById("targetProcessed").innerText =
            data.summary?.targets?.processed_drugs ?? "-";

        resultBox.style.display = "block";

    } catch (err) {
        alert("Error during ChEMBL sync");
        console.error(err);
    } finally {
        spinner.style.display = "none";
        btn.disabled = false;
    }
}
</script>
{% endblock %}
