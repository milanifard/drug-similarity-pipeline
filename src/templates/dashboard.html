{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h1>ğŸ“Š System Dashboard</h1>

<!-- ================= Summary Cards ================= -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>Local ChEMBL Drugs</h3>
        <div class="stat-value" id="chemblCount">â€“</div>
    </div>

    <div class="stat-card">
        <h3>Imported Drugs</h3>
        <div class="stat-value" id="importedCount">â€“</div>
    </div>

    <div class="stat-card">
        <h3>Failed Imports</h3>
        <div class="stat-value" id="failedCount">â€“</div>
    </div>
</div>

<!-- ================= Import Status Table ================= -->
<h2 style="margin-top:40px;">ğŸ“¦ Import Status</h2>

<table>
    <thead>
        <tr>
            <th>Status</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id="statusTable"></tbody>
</table>

<!-- ================= NOT IN CHEMBL Reasons ================= -->
<h2 style="margin-top:40px;">âŒ Not in ChEMBL â€“ Reasons</h2>

<table>
    <thead>
        <tr>
            <th>Reason</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id="reasonTable"></tbody>
</table>

<script>
async function loadSystemStats() {
    const res = await fetch("/system/stats");
    const data = await res.json();

    // -------- Summary Cards --------
    document.getElementById("chemblCount").innerText = data.chembl_local_count;

    let imported = 0;
    let failed = 0;

    const statusTbody = document.getElementById("statusTable");
    statusTbody.innerHTML = "";

    data.local_import_status.forEach(r => {
        statusTbody.innerHTML += `
            <tr>
                <td>${r.status}</td>
                <td>${r.count}</td>
            </tr>
        `;

        if (r.status === "IMPORTED") imported += r.count;
        if (r.status !== "IMPORTED") failed += r.count;
    });

    document.getElementById("importedCount").innerText = imported;
    document.getElementById("failedCount").innerText = failed;

    // -------- Reasons Table --------
    const reasonTbody = document.getElementById("reasonTable");
    reasonTbody.innerHTML = "";

    data.not_in_chembl_reasons.forEach(r => {
        reasonTbody.innerHTML += `
            <tr>
                <td>${r.message}</td>
                <td>${r.count}</td>
            </tr>
        `;
    });
}

loadSystemStats();
</script>
{% endblock %}
